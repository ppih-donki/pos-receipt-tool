<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>ç°¡æ˜“ãƒ¬ã‚¸ï¼ˆå°è¨ˆï¼‰</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="robots" content="noindex,nofollow" />
  <style>
    :root{
      --bg:#f5f6f8;
      --panel:#ffffff;
      --fg:#111827;
      --muted:#6b7280;
      --border:#e5e7eb;
      --accent:#2563eb;
      --danger:#dc2626;
      --warn:#b45309;
      --ok:#059669;
      --shadow: 0 8px 24px rgba(0,0,0,.08);
      --radius:14px;
    }
    *{ box-sizing:border-box; }
    html,body{ margin:0; padding:0; color:var(--fg); background:var(--bg); font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", "Hiragino Kaku Gothic ProN", "Yu Gothic", sans-serif; }
    button, input, select{ font:inherit; }

    /* ====== Simple Lock (Password Gate) ====== */
    #lockGate{
      position: fixed;
      inset: 0;
      background: rgba(245,246,248,.92);
      backdrop-filter: blur(10px);
      z-index: 9999;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 16px;
    }
    #lockCard{
      width: min(520px, 100%);
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
    }
    #lockCard .h{
      padding: 14px 14px;
      border-bottom: 1px solid var(--border);
      font-weight: 700;
      font-size: 14px;
    }
    #lockCard .b{
      padding: 14px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    #lockRow{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    #lockPw{
      flex:1;
      min-width: 220px;
      padding: 12px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: #fff;
      outline: none;
    }
    #lockPw:focus{ border-color: rgba(37,99,235,.5); box-shadow: 0 0 0 4px rgba(37,99,235,.12); }
    #lockErr{
      display:none;
      border-radius:12px;
      padding:10px 12px;
      border:1px solid rgba(220,38,38,.25);
      background: rgba(220,38,38,.08);
      color: #7f1d1d;
      font-size: 13px;
    }
    #lockNote{
      border-radius:12px;
      padding:10px 12px;
      border:1px solid var(--border);
      background:#fafafa;
      font-size:13px;
      color:var(--muted);
    }

    .wrap{ max-width:1100px; margin:0 auto; padding:14px; }
    .header{
      position: sticky;
      top: 0;
      z-index: 5;
      background: rgba(245,246,248,.9);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--border);
    }
    .header-inner{
      max-width:1100px;
      margin:0 auto;
      padding:10px 14px;
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
    }
    .title{
      display:flex;
      flex-direction:column;
      gap:2px;
      min-width: 200px;
    }
    .title h1{
      font-size:16px;
      line-height:1.2;
      margin:0;
      font-weight:700;
    }
    .meta{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      border:1px solid var(--border);
      background: var(--panel);
      border-radius:999px;
      padding:8px 10px;
      font-size:12px;
      box-shadow: 0 1px 0 rgba(0,0,0,.02);
      white-space:nowrap;
    }
    .dot{ width:10px; height:10px; border-radius:50%; background: var(--muted); display:inline-block; }
    .dot.ok{ background: var(--ok); }
    .dot.ng{ background: var(--danger); }

    .grid{
      display:grid;
      grid-template-columns: 1fr 360px;
      gap:14px;
      margin-top:14px;
    }
    .card{
      background: var(--panel);
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card-h{
      padding:12px 14px;
      border-bottom:1px solid var(--border);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .card-h h2{
      margin:0;
      font-size:14px;
      font-weight:700;
    }
    .card-b{
      padding:14px;
    }

    .row{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .field{
      display:flex;
      flex-direction:column;
      gap:6px;
      flex:1;
      min-width: 220px;
    }
    .label{
      font-size:12px;
      color:var(--muted);
    }
    select, input[type="text"], input[type="number"], input[type="date"]{
      width:100%;
      padding:12px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      background:#fff;
      outline:none;
    }
    input:focus, select:focus{ border-color: rgba(37,99,235,.5); box-shadow: 0 0 0 4px rgba(37,99,235,.12); }

    .btn{
      border:1px solid var(--border);
      background:#fff;
      padding:12px 12px;
      border-radius:12px;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      min-height:44px;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .btn:hover{ border-color:#d1d5db; }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{
      background: var(--accent);
      color:#fff;
      border-color: rgba(0,0,0,0);
    }
    .btn.primary:hover{ filter:brightness(.98); }
    .btn.danger{
      background: var(--danger);
      color:#fff;
      border-color: rgba(0,0,0,0);
    }
    .btn.ghost{
      background: transparent;
    }
    .btn.small{
      padding:10px 10px;
      min-height:40px;
      border-radius:10px;
      font-size:13px;
    }
    .btn.icon{
      width:44px;
      padding:0;
    }
    .btn[disabled]{
      opacity:.5;
      cursor:not-allowed;
      transform:none;
    }

    .notice{
      border-radius:12px;
      padding:10px 12px;
      border:1px solid var(--border);
      background:#fafafa;
      font-size:13px;
      color:var(--muted);
    }
    .notice.err{
      border-color: rgba(220,38,38,.25);
      background: rgba(220,38,38,.08);
      color: #7f1d1d;
    }
    .notice.warn{
      border-color: rgba(180,83,9,.25);
      background: rgba(180,83,9,.10);
      color: #7c2d12;
    }
    .notice.ok{
      border-color: rgba(5,150,105,.25);
      background: rgba(5,150,105,.10);
      color: #064e3b;
    }

    .table-wrap{ overflow:auto; }
    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      min-width: 680px;
    }
    th, td{
      padding:10px 10px;
      border-bottom:1px solid var(--border);
      vertical-align:middle;
      font-size:13px;
    }
    th{
      text-align:left;
      color:var(--muted);
      font-weight:600;
      background:#fafafa;
      position:sticky;
      top:0;
      z-index:1;
    }
    tr:last-child td{ border-bottom:none; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .right{ text-align:right; }
    .muted{ color:var(--muted); }

    .qty{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      min-width: 170px;
    }
    .qty input{
      width: 72px;
      text-align:center;
      padding:10px 8px;
      border-radius:10px;
    }

    .summary{
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .sum-block{
      border:1px solid var(--border);
      border-radius:12px;
      padding:10px 12px;
      background:#fff;
    }
    .sum-title{
      font-weight:700;
      font-size:13px;
      margin-bottom:8px;
    }
    .sum-row{
      display:flex;
      justify-content:space-between;
      gap:10px;
      padding:4px 0;
      font-size:13px;
    }
    .sum-row strong{ font-size:14px; }
    .divider{
      height:1px;
      background: var(--border);
      margin:8px 0;
    }

    .sticky-actions{
      position: sticky;
      bottom: 0;
      background: rgba(255,255,255,.85);
      backdrop-filter: blur(10px);
      border-top:1px solid var(--border);
      padding:10px 14px;
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
    }
    .sticky-actions .left, .sticky-actions .right{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }

    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
      table{ min-width: 760px; }
    }
    @media (max-width: 520px){
      .header-inner{ flex-direction:column; align-items:flex-start; }
      .meta{ justify-content:flex-start; }
      .field{ min-width: 100%; }
      .sticky-actions{ flex-direction:column; align-items:stretch; }
      .sticky-actions .left, .sticky-actions .right{ width:100%; justify-content:space-between; }
      .btn{ width:100%; }
      .btn.icon{ width:44px; }
      #lockRow{ flex-direction: column; align-items: stretch; }
      #lockRow .btn{ width: 100%; }
    }
  </style>
</head>

<body>
  <!-- Password Gate -->
  <div id="lockGate" aria-hidden="true">
    <div id="lockCard" role="dialog" aria-modal="true" aria-label="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å…¥åŠ›">
      <div class="h">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›</div>
      <div class="b">
        <div id="lockErr">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™ã€‚</div>
        <div id="lockRow">
          <input id="lockPw" type="password" inputmode="numeric" autocomplete="current-password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" />
          <button class="btn primary" id="lockBtn" type="button">é–‹ã</button>
        </div>
        <div id="lockNote">â€»ã“ã®ç«¯æœ«ã§ã¯30æ—¥é–“ã€å†å…¥åŠ›ä¸è¦ã«ã§ãã¾ã™ã€‚</div>
      </div>
    </div>
  </div>

  <div id="appRoot" hidden>
    <div class="header">
      <div class="header-inner">
        <div class="title">
          <h1>ç°¡æ˜“ãƒ¬ã‚¸ï¼ˆå°è¨ˆï¼‰</h1>
          <div class="muted" style="font-size:12px;">JST: <span id="nowJst" class="mono">----</span></div>
        </div>
        <div class="meta">
          <div class="pill" title="ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯çŠ¶æ…‹">
            <span id="netDot" class="dot"></span>
            <span id="netText">--</span>
          </div>
          <div class="pill" title="å°è¨ˆçŠ¶æ…‹">
            <span id="calcState" class="muted">å°è¨ˆæœªå®Ÿè¡Œ</span>
          </div>
        </div>
      </div>
    </div>

    <div class="wrap">
      <div class="grid">
        <div class="card">
          <div class="card-h">
            <h2>ã‚¹ã‚­ãƒ£ãƒ³ãƒ»æ˜ç´°</h2>
            <button class="btn ghost small" id="btnClear" type="button">ä¼šè¨ˆã‚’ã‚¯ãƒªã‚¢</button>
          </div>

          <div class="card-b">
            <div class="row" style="margin-bottom:12px;">
              <div class="field" style="max-width:360px;">
                <div class="label">ãƒ¬ã‚¸æ‹…å½“è€…ï¼ˆå¿…é ˆï¼‰</div>
                <select id="cashierName">
                  <option value="">èª­ã¿è¾¼ã¿ä¸­...</option>
                </select>
              </div>

              <div class="field">
                <div class="label">ãƒãƒ¼ã‚³ãƒ¼ãƒ‰å…¥åŠ›ï¼ˆã‚¹ã‚­ãƒ£ãƒŠã®Enterã§è¿½åŠ ï¼‰</div>
                <input id="scanInput" type="text" inputmode="numeric" autocomplete="off" placeholder="ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦ãã ã•ã„ï¼ˆæ•°å­—1ã€œ13æ¡ï¼‰" />
              </div>

              <div style="display:flex; gap:10px; align-items:flex-end; flex-wrap:wrap;">
                <button class="btn small" type="button" id="btnAddManual">JANæ‰‹å…¥åŠ›</button>
                <button class="btn small" type="button" id="btnFocus">JANã‚¹ã‚­ãƒ£ãƒ³</button>
              </div>
            </div>

            <div id="noticeArea" class="notice" style="margin-bottom:12px;">
              åˆæœŸåŒ–ä¸­...
            </div>

            <div class="row" style="margin-bottom:10px;">
              <div class="notice" style="flex:1;">
                æœ€å¾Œã«è¿½åŠ ã—ãŸå•†å“ï¼š<span id="lastAdded" class="muted">---</span>
              </div>
            </div>

            <div class="table-wrap card" style="box-shadow:none; border-radius:12px; border:1px solid var(--border);">
              <table>
                <thead>
                  <tr>
                    <th style="width:42%;">å•†å“</th>
                    <th style="width:8%;">ç¨ç‡</th>
                    <th class="right" style="width:12%;">ç¨æŠœå˜ä¾¡</th>
                    <th style="width:20%; text-align:center;">æ•°é‡</th>
                    <th class="right" style="width:12%;">ç¨æŠœé‡‘é¡</th>
                    <th style="width:6%; text-align:center;">å‰Šé™¤</th>
                  </tr>
                </thead>
                <tbody id="itemsTbody"></tbody>
              </table>
            </div>

            <div style="margin-top:12px;" class="notice warn" id="staleNotice" hidden>
              æ˜ç´°ãŒæ›´æ–°ã•ã‚Œã¾ã—ãŸã€‚å°è¨ˆã¯æœªæ›´æ–°ã§ã™ï¼ˆå°è¨ˆãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ï¼‰ã€‚
            </div>
          </div>

          <div class="sticky-actions">
            <div class="left">
              <button class="btn primary" id="btnSubtotal" type="button">å°è¨ˆï¼ˆç¨ç‡åˆ¥ï¼‰</button>
            </div>
            <div class="right">
              <span class="muted" style="font-size:12px;">â€»ç¨é¡ã¯ã€Œç¨ç‡åˆ¥ç¨æŠœå°è¨ˆã€Ã—ç¨ç‡ ã‚’1å††æœªæº€åˆ‡ã‚Šä¸Šã’</span>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-h">
            <h2>å°è¨ˆãƒ»ç™»éŒ²</h2>
          </div>

          <div class="card-b">
            <div class="summary" style="margin-bottom:14px;">
              <div class="sum-block">
                <div class="sum-title">10% å¯¾è±¡</div>
                <div class="sum-row"><span class="muted">ç¨æŠœå°è¨ˆ</span><span class="mono" id="excl10">0</span></div>
                <div class="sum-row"><span class="muted">ç¨é¡ï¼ˆåˆ‡ä¸Šã’ï¼‰</span><span class="mono" id="tax10">0</span></div>
                <div class="divider"></div>
                <div class="sum-row"><strong>ç¨è¾¼å°è¨ˆ</strong><strong class="mono" id="incl10">0</strong></div>
              </div>

              <div class="sum-block">
                <div class="sum-title">8% å¯¾è±¡</div>
                <div class="sum-row"><span class="muted">ç¨æŠœå°è¨ˆ</span><span class="mono" id="excl8">0</span></div>
                <div class="sum-row"><span class="muted">ç¨é¡ï¼ˆåˆ‡ä¸Šã’ï¼‰</span><span class="mono" id="tax8">0</strong></div>
                <div class="divider"></div>
                <div class="sum-row"><strong>ç¨è¾¼å°è¨ˆ</strong><strong class="mono" id="incl8">0</strong></div>
              </div>

              <div class="sum-block" style="border-color: rgba(37,99,235,.25); background: rgba(37,99,235,.06);">
                <div class="sum-row"><strong>åˆè¨ˆï¼ˆç¨è¾¼ï¼‰</strong><strong class="mono" id="totalIncl">0</strong></div>
              </div>
            </div>

            <div class="field" style="margin-bottom:10px;">
              <div class="label">ãƒ¬ã‚·ãƒ¼ãƒˆç•ªå·ã‚’å…¥åŠ›ï¼ˆåŒæ—¥ã«åŒã˜ãƒ¬ã‚·ãƒ¼ãƒˆç•ªå·ã¯ç™»éŒ²ä¸å¯ï¼‰</div>
              <input id="receiptNo" type="text" autocomplete="off" placeholder="æ±ºæ¸ˆãƒ¬ã‚·ãƒ¼ãƒˆç•ªå·ã‚’å…¥åŠ›ï¼ˆåŠè§’è‹±æ•°ï¼‰" />
            </div>

            <div class="notice" style="margin-bottom:10px;">
              transaction_idï¼š<span class="mono" id="txId">----</span>
            </div>

            <div class="row" style="margin-bottom:10px;">
              <button class="btn primary" id="btnRegister" type="button" style="flex:1;">ç™»éŒ²</button>
              <button class="btn" id="btnDownloadCsv" type="button" style="flex:1;" hidden>CSVã‚’ä¿å­˜ã™ã‚‹(ç™»éŒ²ã§ããªã„å ´åˆ)</button>
            </div>

            <div class="notice" id="regNotice">
              ç™»éŒ²ã«æˆåŠŸã™ã‚‹ã¨ã€æ˜ç´°ãŒã‚¯ãƒªã‚¢ã•ã‚Œæ¬¡ã®ä¼šè¨ˆã«é€²ã¿ã¾ã™ã€‚é€ä¿¡å¤±æ•—æ™‚ã¯CSVä¿å­˜ç”»é¢ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // =========================
    // Simple Password Gate (local only)
    // =========================
    (function(){
      const PASS = "7532";
      const KEY = "simple_pos_auth_v1";
      const TTL_MS = 30 * 24 * 60 * 60 * 1000;

      const gate = document.getElementById("lockGate");
      const appRoot = document.getElementById("appRoot");
      const pw = document.getElementById("lockPw");
      const btn = document.getElementById("lockBtn");
      const err = document.getElementById("lockErr");

      function readAuth(){
        try{
          const raw = localStorage.getItem(KEY);
          if (!raw) return null;
          const obj = JSON.parse(raw);
          if (!obj || typeof obj.exp !== "number") return null;
          return obj;
        }catch(e){
          return null;
        }
      }

      function isValid(){
        const a = readAuth();
        return !!(a && a.exp > Date.now());
      }

      function openApp(){
        gate.style.display = "none";
        gate.setAttribute("aria-hidden", "true");
        appRoot.hidden = false;
      }

      function showGate(){
        appRoot.hidden = true;
        gate.style.display = "flex";
        gate.setAttribute("aria-hidden", "false");
        err.style.display = "none";
        pw.value = "";
        setTimeout(() => { try{ pw.focus(); }catch(e){} }, 50);
      }

      function saveAuth(){
        const exp = Date.now() + TTL_MS;
        try{
          localStorage.setItem(KEY, JSON.stringify({ exp }));
        }catch(e){}
      }

      function tryUnlock(){
        if (String(pw.value || "").trim() === PASS){
          saveAuth();
          openApp();
        } else {
          err.style.display = "block";
          try{ pw.focus(); pw.select(); }catch(e){}
        }
      }

      btn.addEventListener("click", tryUnlock);
      pw.addEventListener("keydown", (e) => {
        if (e.key === "Enter"){
          e.preventDefault();
          tryUnlock();
        }
      });

      if (isValid()){
        openApp();
      } else {
        showGate();
      }
    })();
  </script>

  <script>
    // =========================
    // Config
    // =========================
    const API = {
      cashiers: "/api/cashiers",
      productByCode: (code) => `/api/products?code=${encodeURIComponent(code)}`,
      register: "/api/transactions",
    };

    // =========================
    // State
    // =========================
    const state = {
      itemsByCode: new Map(), // product_code => item
      lastAddedText: "---",
      subtotal: {
        excl8: 0, tax8: 0, incl8: 0,
        excl10: 0, tax10: 0, incl10: 0,
        totalIncl: 0
      },
      subtotalFresh: false,
    };

    // =========================
    // Elements
    // =========================
    const elNowJst = document.getElementById("nowJst");
    const elNetDot = document.getElementById("netDot");
    const elNetText = document.getElementById("netText");
    const elCalcState = document.getElementById("calcState");

    const elCashierName = document.getElementById("cashierName");
    const elScanInput = document.getElementById("scanInput");
    const elBtnAddManual = document.getElementById("btnAddManual");
    const elBtnFocus = document.getElementById("btnFocus");
    const elNoticeArea = document.getElementById("noticeArea");
    const elLastAdded = document.getElementById("lastAdded");
    const elItemsTbody = document.getElementById("itemsTbody");
    const elStaleNotice = document.getElementById("staleNotice");

    const elExcl10 = document.getElementById("excl10");
    const elTax10 = document.getElementById("tax10");
    const elIncl10 = document.getElementById("incl10");
    const elExcl8 = document.getElementById("excl8");
    const elTax8 = document.getElementById("tax8");
    const elIncl8 = document.getElementById("incl8");
    const elTotalIncl = document.getElementById("totalIncl");

    const elReceiptNo = document.getElementById("receiptNo");
    const elTxId = document.getElementById("txId");
    const elBtnSubtotal = document.getElementById("btnSubtotal");
    const elBtnRegister = document.getElementById("btnRegister");
    const elBtnClear = document.getElementById("btnClear");
    const elBtnDownloadCsv = document.getElementById("btnDownloadCsv");
    const elRegNotice = document.getElementById("regNotice");

    // =========================
    // JST utils (å¸¸ã«Asia/Tokyoã§ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã™ã‚‹)
    //  - ç«¯æœ«ã®ãƒ­ãƒ¼ã‚«ãƒ«TZã‚„DSTã®å½±éŸ¿ã‚’å—ã‘ãªã„
    //  - å‡ºåŠ›ã¯ "YYYY-MM-DD HH:mm:ss"
    // =========================
    const JST_FMT = new Intl.DateTimeFormat("sv-SE", {
      timeZone: "Asia/Tokyo",
      year: "numeric",
      month: "2-digit",
      day: "2-digit",
      hour: "2-digit",
      minute: "2-digit",
      second: "2-digit",
      hour12: false
    });

    function formatNowJst(){
      // sv-SEã¯ "YYYY-MM-DD HH:mm:ss" å½¢å¼ã§è¿”ã‚‹
      return JST_FMT.format(new Date());
    }

    function yyyymmddFromRegisteredAtJst(registeredAtJst){
      // "YYYY-MM-DD HH:mm:ss" -> "YYYYMMDD"
      return registeredAtJst.slice(0,4) + registeredAtJst.slice(5,7) + registeredAtJst.slice(8,10);
    }

    // =========================
    // UI helpers
    // =========================
    function setNotice(type, text){
      elNoticeArea.className = "notice" + (type ? ` ${type}` : "");
      elNoticeArea.textContent = text;
    }
    function setRegNotice(type, text){
      elRegNotice.className = "notice" + (type ? ` ${type}` : "");
      elRegNotice.textContent = text;
    }
    function money(n){ return (n ?? 0).toLocaleString("ja-JP"); }
    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, (c) => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
      }[c]));
    }

    function markSubtotalStale(){
      state.subtotalFresh = false;
      elStaleNotice.hidden = false;
      elCalcState.textContent = "å°è¨ˆæœªæ›´æ–°";
    }

    function markSubtotalFresh(){
      state.subtotalFresh = true;
      elStaleNotice.hidden = true;
      elCalcState.textContent = "å°è¨ˆOK";
    }

    function updateNetworkBadge(){
      const online = navigator.onLine;
      elNetDot.classList.toggle("ok", online);
      elNetDot.classList.toggle("ng", !online);
      elNetText.textContent = online ? "ã‚ªãƒ³ãƒ©ã‚¤ãƒ³" : "ã‚ªãƒ•ãƒ©ã‚¤ãƒ³";
    }

    function sanitizeReceiptForTx(receiptNo){
      return String(receiptNo || "").trim().replace(/[^A-Za-z0-9_-]/g, "_");
    }

    function updateTxIdPreview(){
      const r = sanitizeReceiptForTx(elReceiptNo.value);
      if (!r) {
        elTxId.textContent = "----";
        return;
      }
      const registeredAtJst = formatNowJst();
      const ymd = yyyymmddFromRegisteredAtJst(registeredAtJst);
      elTxId.textContent = `${ymd}_${r}`;
    }

    // =========================
    // API helpers
    // =========================
    async function apiGetJson(url){
      const res = await fetch(url, { method:"GET", headers:{ "Accept":"application/json" } });
      if (!res.ok){
        const t = await res.text().catch(()=> "");
        throw new Error(`GET ${url} failed: ${res.status} ${t}`);
      }
      return await res.json();
    }

    async function apiPostJson(url, body){
      const res = await fetch(url, {
        method:"POST",
        headers:{ "Content-Type":"application/json", "Accept":"application/json" },
        body: JSON.stringify(body)
      });
      const dataText = await res.text().catch(()=> "");
      let data = null;
      try { data = dataText ? JSON.parse(dataText) : null; } catch(e) {}
      if (!res.ok){
        const msg = (data && data.error) ? data.error : dataText || `HTTP ${res.status}`;
        const err = new Error(msg);
        err.status = res.status;
        err.data = data;
        throw err;
      }
      return data;
    }

    // =========================
    // Cashiers
    // =========================
    async function loadCashiers(){
      try{
        const data = await apiGetJson(API.cashiers);
        const names = (data.cashiers || []).map(x => x.cashier_name).filter(Boolean);
        if (names.length === 0){
          elCashierName.innerHTML = `<option value="">ï¼ˆå¾“æ¥­å“¡ãŒæœªç™»éŒ²ï¼‰</option>`;
          setNotice("warn", "å¾“æ¥­å“¡ãƒã‚¹ã‚¿ãŒç©ºã§ã™ã€‚å…ˆã«å¾“æ¥­å“¡ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚");
          return;
        }
        elCashierName.innerHTML = `<option value="">é¸æŠã—ã¦ãã ã•ã„</option>` + names.map(n => `<option value="${escapeHtml(n)}">${escapeHtml(n)}</option>`).join("");
        setNotice("", "æº–å‚™å®Œäº†ã€‚ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦ãã ã•ã„ã€‚");
      } catch(e){
        elCashierName.innerHTML = `<option value="">ï¼ˆèª­è¾¼å¤±æ•—ï¼‰</option>`;
        setNotice("err", "å¾“æ¥­å“¡ãƒã‚¹ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚API/DBè¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
      }
    }

    // =========================
    // Product lookup
    // =========================
    async function fetchProductByCode(code){
      const data = await apiGetJson(API.productByCode(code));
      return data.product || null;
    }

    // =========================
    // Items
    // =========================
    function upsertItem(product){
      const code = product.product_code;
      const existing = state.itemsByCode.get(code);

      if (existing){
        existing.qty += 1;
        existing.line_amount_excl = existing.price_excl * existing.qty;
        state.lastAddedText = `${existing.product_name}ï¼ˆæ•°é‡ ${existing.qty}ï¼‰`;
      } else {
        const qty = 1;
        const it = {
          product_code: product.product_code,
          product_category: product.product_category || "",
          product_name: product.product_name,
          pos_cost: product.pos_cost == null ? null : (Number(product.pos_cost) | 0),
          price_excl: (Number(product.price_excl) | 0),
          tax_rate: Number(product.tax_rate) === 8 ? 8 : 10,
          qty: qty,
          line_amount_excl: (Number(product.price_excl) | 0) * qty,
        };
        state.itemsByCode.set(code, it);
        state.lastAddedText = `${it.product_name}ï¼ˆæ•°é‡ 1ï¼‰`;
      }

      elLastAdded.textContent = state.lastAddedText;
      renderItems();
      markSubtotalStale();
    }

    function setQty(code, qty){
      const it = state.itemsByCode.get(code);
      if (!it) return;
      const q = Math.max(1, qty | 0);
      it.qty = q;
      it.line_amount_excl = it.price_excl * it.qty;

      state.lastAddedText = `${it.product_name}ï¼ˆæ•°é‡ ${it.qty}ï¼‰`;
      elLastAdded.textContent = state.lastAddedText;
      renderItems();
      markSubtotalStale();
    }

    function incQty(code){ setQty(code, (state.itemsByCode.get(code)?.qty || 1) + 1); }
    function decQty(code){ setQty(code, (state.itemsByCode.get(code)?.qty || 1) - 1); }

    function removeItem(code){
      const it = state.itemsByCode.get(code);
      if (!it) return;
      state.itemsByCode.delete(code);
      state.lastAddedText = `${it.product_name} ã‚’å‰Šé™¤`;
      elLastAdded.textContent = state.lastAddedText;
      renderItems();
      markSubtotalStale();
    }

    function renderItems(){
      const items = Array.from(state.itemsByCode.values());

      if (items.length === 0){
        elItemsTbody.innerHTML = `
          <tr>
            <td colspan="6" class="muted" style="padding:14px;">
              ã¾ã å•†å“ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦ãã ã•ã„ã€‚
            </td>
          </tr>
        `;
        return;
      }

      elItemsTbody.innerHTML = items.map(it => {
        const taxLabel = it.tax_rate === 8 ? "8%" : "10%";
        const sub = it.product_category ? ` <span class="muted">/ ${escapeHtml(it.product_category)}</span>` : "";
        return `
          <tr data-code="${escapeHtml(it.product_code)}">
            <td>
              <div style="display:flex; flex-direction:column; gap:2px;">
                <div style="font-weight:700;">${escapeHtml(it.product_name)}${sub}</div>
                <div class="muted mono" style="font-size:12px;">${escapeHtml(it.product_code)}</div>
              </div>
            </td>
            <td class="mono">${taxLabel}</td>
            <td class="right mono">${money(it.price_excl)}</td>
            <td>
              <div class="qty">
                <button class="btn small icon" type="button" data-act="dec" title="æ•°é‡ã‚’æ¸›ã‚‰ã™">âˆ’</button>
                <input class="mono" type="number" min="1" step="1" inputmode="numeric" data-act="qty" value="${it.qty}">
                <button class="btn small icon" type="button" data-act="inc" title="æ•°é‡ã‚’å¢—ã‚„ã™">ï¼‹</button>
              </div>
            </td>
            <td class="right mono">${money(it.line_amount_excl)}</td>
            <td style="text-align:center;">
              <button class="btn small danger" type="button" data-act="del" title="å‰Šé™¤">ğŸ—‘</button>
            </td>
          </tr>
        `;
      }).join("");

      elItemsTbody.querySelectorAll("tr").forEach(tr => {
        const code = tr.getAttribute("data-code");

        tr.querySelector('[data-act="inc"]').addEventListener("click", () => { incQty(code); keepFocus(); });
        tr.querySelector('[data-act="dec"]').addEventListener("click", () => { decQty(code); keepFocus(); });
        tr.querySelector('[data-act="del"]').addEventListener("click", () => { removeItem(code); keepFocus(); });

        const qtyInput = tr.querySelector('[data-act="qty"]');
        qtyInput.addEventListener("change", () => {
          const v = Number(qtyInput.value);
          setQty(code, Number.isFinite(v) ? v : 1);
          keepFocus();
        });
        qtyInput.addEventListener("focus", () => {
          try{ qtyInput.select(); }catch(e){}
        });
      });
    }

    // =========================
    // Subtotal
    // ç¨é¡: ç¨ç‡åˆ¥ç¨æŠœå°è¨ˆ Ã— ç¨ç‡ ã‚’1å††æœªæº€åˆ‡ã‚Šä¸Šã’
    // =========================
    function calcTaxCeil(subtotalExcl, taxRate){
      return Math.ceil((subtotalExcl * taxRate) / 100);
    }

    function runSubtotal(){
      const items = Array.from(state.itemsByCode.values());
      if (items.length === 0){
        setNotice("warn", "å•†å“ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦ãã ã•ã„ã€‚");
        return;
      }

      const excl8 = items.filter(i => i.tax_rate === 8).reduce((a,b)=>a+b.line_amount_excl, 0);
      const excl10 = items.filter(i => i.tax_rate === 10).reduce((a,b)=>a+b.line_amount_excl, 0);

      const tax8 = calcTaxCeil(excl8, 8);
      const tax10 = calcTaxCeil(excl10, 10);

      const incl8 = excl8 + tax8;
      const incl10 = excl10 + tax10;
      const totalIncl = incl8 + incl10;

      state.subtotal = { excl8, tax8, incl8, excl10, tax10, incl10, totalIncl };

      elExcl8.textContent = money(excl8);
      elTax8.textContent = money(tax8);
      elIncl8.textContent = money(incl8);
      elExcl10.textContent = money(excl10);
      elTax10.textContent = money(tax10);
      elIncl10.textContent = money(incl10);
      elTotalIncl.textContent = money(totalIncl);

      markSubtotalFresh();
      setNotice("ok", "å°è¨ˆã‚’æ›´æ–°ã—ã¾ã—ãŸã€‚å†…å®¹ãŒæ­£ã—ã‘ã‚Œã°æ±ºæ¸ˆç«¯æœ«ã§ä¼šè¨ˆã—ã€ãƒ¬ã‚·ãƒ¼ãƒˆç•ªå·ã‚’å…¥åŠ›ã—ã¦ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚");
    }

    // =========================
    // CSV (offline or failure)
    // =========================
    function csvEscape(v){
      const s = String(v ?? "");
      if (/[",\n\r]/.test(s)) return `"${s.replace(/"/g,'""')}"`;
      return s;
    }

    function calcSubtotalSnapshotForCsv(items){
      const excl8 = items.filter(i => i.tax_rate === 8).reduce((a,b)=>a+b.line_amount_excl, 0);
      const excl10 = items.filter(i => i.tax_rate === 10).reduce((a,b)=>a+b.line_amount_excl, 0);
      const tax8 = calcTaxCeil(excl8, 8);
      const tax10 = calcTaxCeil(excl10, 10);
      const incl8 = excl8 + tax8;
      const incl10 = excl10 + tax10;
      const totalIncl = incl8 + incl10;
      return { excl8, tax8, incl8, excl10, tax10, incl10, totalIncl };
    }

    function buildCsvText(registeredAtJst, receiptNo, transactionId, cashierName){
      const items = Array.from(state.itemsByCode.values());
      const s = state.subtotalFresh ? state.subtotal : calcSubtotalSnapshotForCsv(items);

      const header = [
        "registered_at_jst",
        "receipt_no",
        "transaction_id",
        "cashier_name",
        "record_type",
        "product_code",
        "product_category",
        "product_name",
        "pos_cost",
        "price_excl",
        "qty",
        "line_amount_excl",
        "tax_rate",
        "taxable_amount_excl",
        "tax_amount",
        "taxable_amount_incl"
      ];

      const rows = [];
      rows.push(header);

      for (const it of items){
        rows.push([
          registeredAtJst, receiptNo, transactionId, cashierName,
          "ITEM",
          it.product_code, it.product_category, it.product_name,
          it.pos_cost == null ? "" : String(it.pos_cost),
          String(it.price_excl),
          String(it.qty),
          String(it.line_amount_excl),
          String(it.tax_rate),
          "", "", ""
        ]);
      }

      if (s.excl10 > 0 || s.tax10 > 0 || s.incl10 > 0){
        rows.push([
          registeredAtJst, receiptNo, transactionId, cashierName,
          "TAX_SUMMARY",
          "", "", "", "", "", "", "",
          "10",
          String(s.excl10),
          String(s.tax10),
          String(s.incl10)
        ]);
      }
      if (s.excl8 > 0 || s.tax8 > 0 || s.incl8 > 0){
        rows.push([
          registeredAtJst, receiptNo, transactionId, cashierName,
          "TAX_SUMMARY",
          "", "", "", "", "", "", "",
          "8",
          String(s.excl8),
          String(s.tax8),
          String(s.incl8)
        ]);
      }

      return rows.map(cols => cols.map(csvEscape).join(",")).join("\n");
    }

    function downloadCsv(filename, text){
      const blob = new Blob([text], { type: "text/csv;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    // =========================
    // Register
    // =========================
    async function registerTransaction(){
      const cashierName = (elCashierName.value || "").trim();
      if (!cashierName){
        setRegNotice("warn", "ãƒ¬ã‚¸æ‹…å½“è€…ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");
        return;
      }

      const items = Array.from(state.itemsByCode.values());
      if (items.length === 0){
        setRegNotice("warn", "å•†å“ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦ãã ã•ã„ã€‚");
        return;
      }

      const receiptNo = (elReceiptNo.value || "").trim();
      if (!receiptNo){
        setRegNotice("warn", "ãƒ¬ã‚·ãƒ¼ãƒˆç•ªå·ãŒæœªå…¥åŠ›ã§ã™ã€‚å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
        elReceiptNo.focus();
        return;
      }

      if (!state.subtotalFresh){
        runSubtotal();
      }

      const registeredAtJst = formatNowJst();
      const ymd = yyyymmddFromRegisteredAtJst(registeredAtJst);
      const txId = `${ymd}_${sanitizeReceiptForTx(receiptNo)}`;

      const payload = {
        receipt_no: receiptNo,
        registered_at_jst: registeredAtJst,
        cashier_name: cashierName,
        items: items.map(it => ({
          product_code: it.product_code,
          product_category: it.product_category,
          product_name: it.product_name,
          pos_cost: it.pos_cost,
          price_excl: it.price_excl,
          tax_rate: it.tax_rate,
          qty: it.qty
        }))
      };

      if (!navigator.onLine){
        const csv = buildCsvText(registeredAtJst, receiptNo, txId, cashierName);
        showCsvFallback(txId, csv);
        setRegNotice("err", "é€ä¿¡ã§ãã¾ã›ã‚“ï¼ˆã‚ªãƒ•ãƒ©ã‚¤ãƒ³ï¼‰ã€‚CSVã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ä¿ç®¡ã—ã¦ãã ã•ã„ã€‚");
        return;
      }

      try{
        elBtnRegister.disabled = true;
        elBtnRegister.textContent = "ç™»éŒ²ä¸­...";
        elBtnDownloadCsv.hidden = true;

        const res = await apiPostJson(API.register, payload);

        setRegNotice("ok", `ç™»éŒ²ã—ã¾ã—ãŸï¼š${res.transaction_id}`);
        resetAll(true);
        keepFocus();
      } catch(e){
        const msg = e && e.message ? e.message : "ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ";
        const csv = buildCsvText(registeredAtJst, receiptNo, txId, cashierName);
        showCsvFallback(txId, csv);
        setRegNotice("err", `ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸã€‚CSVã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚ã‚¨ãƒ©ãƒ¼ï¼š${msg}`);
      } finally {
        elBtnRegister.disabled = false;
        elBtnRegister.textContent = "ç™»éŒ²";
      }
    }

    function showCsvFallback(txId, csvText){
      elBtnDownloadCsv.hidden = false;
      elBtnDownloadCsv.onclick = () => downloadCsv(`${txId}.csv`, csvText);
    }

    // =========================
    // Scan handling
    // =========================
    function normalizeScanCode(raw){
      const s = String(raw || "").trim().replace(/[^\d]/g, "");
      return s;
    }

    async function handleScanCommit(raw){
      const cashierName = (elCashierName.value || "").trim();
      if (!cashierName){
        setNotice("warn", "å…ˆã«ãƒ¬ã‚¸æ‹…å½“è€…ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");
        return;
      }

      const code = normalizeScanCode(raw);
      if (!code){
        setNotice("", "ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦ãã ã•ã„ã€‚");
        return;
      }
      if (!/^\d{1,13}$/.test(code)){
        setNotice("err", "å•†å“ã‚³ãƒ¼ãƒ‰ã¯æ•°å­—1ã€œ13æ¡ã®ã¿å¯¾å¿œã§ã™ã€‚");
        return;
      }

      try{
        setNotice("", "å‚ç…§ä¸­...");
        const product = await fetchProductByCode(code);
        if (!product){
          setNotice("err", `å•†å“ãƒã‚¹ã‚¿ã«ã‚ã‚Šã¾ã›ã‚“ï¼š${code}`);
          return;
        }
        upsertItem(product);
        setNotice("ok", `è¿½åŠ ï¼š${product.product_name}ï¼ˆ${product.tax_rate}%ï¼‰`);
      } catch(e){
        setNotice("err", "å•†å“å‚ç…§ã«å¤±æ•—ã—ã¾ã—ãŸã€‚é€šä¿¡çŠ¶æ…‹/APIè¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
      }
    }

    function keepFocus(){
      try{
        elScanInput.focus();
        elScanInput.select();
      }catch(e){}
    }

    // =========================
    // Reset
    // =========================
    function resetAll(keepCashier){
      state.itemsByCode.clear();
      state.lastAddedText = "---";
      elLastAdded.textContent = state.lastAddedText;

      state.subtotal = { excl8:0, tax8:0, incl8:0, excl10:0, tax10:0, incl10:0, totalIncl:0 };
      state.subtotalFresh = false;

      elExcl8.textContent = "0";
      elTax8.textContent = "0";
      elIncl8.textContent = "0";
      elExcl10.textContent = "0";
      elTax10.textContent = "0";
      elIncl10.textContent = "0";
      elTotalIncl.textContent = "0";

      elReceiptNo.value = "";
      updateTxIdPreview();

      elBtnDownloadCsv.hidden = true;
      setRegNotice("", "ç™»éŒ²ã«æˆåŠŸã™ã‚‹ã¨ã€æ˜ç´°ãŒã‚¯ãƒªã‚¢ã•ã‚Œæ¬¡ã®ä¼šè¨ˆã«é€²ã¿ã¾ã™ã€‚é€ä¿¡å¤±æ•—æ™‚ã¯CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚");

      elStaleNotice.hidden = true;
      elCalcState.textContent = "å°è¨ˆæœªå®Ÿè¡Œ";

      renderItems();

      if (!keepCashier){
        elCashierName.value = "";
      }
    }

    // =========================
    // Bind events
    // =========================
    elScanInput.addEventListener("keydown", async (e) => {
      if (e.key === "Enter"){
        e.preventDefault();
        const v = elScanInput.value;
        elScanInput.value = "";
        await handleScanCommit(v);
        keepFocus();
      }
    });

    elBtnAddManual.addEventListener("click", async () => {
      const v = prompt("å•†å“ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ï¼ˆæ•°å­—1ã€œ13æ¡ï¼‰");
      if (v == null) return;
      await handleScanCommit(v);
      keepFocus();
    });

    elBtnFocus.addEventListener("click", () => keepFocus());

    elBtnSubtotal.addEventListener("click", () => {
      runSubtotal();
      keepFocus();
    });

    elBtnRegister.addEventListener("click", async () => {
      await registerTransaction();
      keepFocus();
    });

    elBtnClear.addEventListener("click", () => {
      const ok = confirm("ã“ã®ä¼šè¨ˆã®å†…å®¹ã‚’ã™ã¹ã¦ã‚¯ãƒªã‚¢ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ");
      if (!ok) return;
      resetAll(true);
      keepFocus();
    });

    elReceiptNo.addEventListener("input", () => updateTxIdPreview());
    elCashierName.addEventListener("change", () => keepFocus());

    window.addEventListener("online", () => { updateNetworkBadge(); });
    window.addEventListener("offline", () => { updateNetworkBadge(); });

    function tick(){
      const jstStr = formatNowJst();
      elNowJst.textContent = jstStr;
      updateTxIdPreview();
    }

    // =========================
    // Init
    // =========================
    updateNetworkBadge();
    tick();
    setInterval(tick, 1000);

    resetAll(true);
    setNotice("", "åˆæœŸåŒ–ä¸­...");
    loadCashiers().finally(() => setTimeout(() => keepFocus(), 200));
  </script>
</body>

</html>



